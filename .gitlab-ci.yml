stages:
  - sync
  - codestyle

variables:
  MENTOR_CONFIG_REPO: "$CI_SERVER_URL/unity-mentorship/templates/student-template-unity.git"

sync-mentor-config:
  stage: sync
  image: alpine:3.20
  before_script:
    - apk add --no-cache git curl
  script:
    - echo "[sync] Cloning mentor config from $MENTOR_CONFIG_REPO"
    - git clone --depth 1 "$MENTOR_CONFIG_REPO" mentor-template

      # –õ–æ–ª–æ—á–∫–∏–Ω —à–æ–∫–æ–ª–∞–¥
      # –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥–∏ + –ø–∞–π–ø–ª–∞–π–Ω –∏–∑ —à–∞–±–ª–æ–Ω–∞
    - cp mentor-template/.editorconfig .
    - cp mentor-template/Directory.Build.props .
    - cp mentor-template/.csharpierignore . || echo "No .csharpierignore in template, skipping."
    - cp mentor-template/.gitlab-ci.yml . || echo "No .gitlab-ci.yml in template, skipping."
    - cp mentor-template/.gitattributes . || echo "No .gitattributes in template, skipping."
    - rm -rf mentor-template

      # –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç ‚Äî –≤—ã—Ö–æ–¥–∏–º
    - |
      if git diff --quiet; then
        echo "[sync] No changes from template."
        exit 0
      fi

      # –í–µ—Ç–∫–∞ —Å–∏–Ω–∫–∞
    - BRANCH="mentor-sync-$(date +%Y%m%d-%H%M%S)"
    - git checkout -b "$BRANCH"

      # –ê–≤—Ç–æ—Ä –∫–æ–º–º–∏—Ç–∞
    - git config user.email "ci@unity-mentor.ru"
    - git config user.name "MentorSyncBot"

      # –°—Ç–∞–¥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã
    - git add .editorconfig Directory.Build.props .csharpierignore .gitlab-ci.yml || true

      # –ï—Å–ª–∏ –ø–æ—Å–ª–µ add –Ω–µ—á–µ–≥–æ –∫–æ–º–º–∏—Ç–∏—Ç—å ‚Äî —Ç–æ–∂–µ –≤—ã—Ö–æ–¥–∏–º
    - |
      if git diff --cached --quiet; then
        echo "[sync] Nothing to commit after staging changes."
        exit 0
      fi

      # –ö–æ–º–º–∏—Ç
    - git commit -m "Sync mentor config from template"

      # üîë –ü—É—à–∏–º —á–µ—Ä–µ–∑ —Ç–æ–∫–µ–Ω: –ª—é–±–æ–π username + —Ç–æ–∫–µ–Ω –∫–∞–∫ –ø–∞—Ä–æ–ª—å
    - >
      git push -u
      "https://sync-bot:${MENTOR_SYNC_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
      "$BRANCH"

      # üîÅ –°–æ–∑–¥–∞—ë–º MR –∏–∑ BRANCH –≤ $CI_DEFAULT_BRANCH, –µ—Å–ª–∏ –µ–≥–æ –µ—â—ë –Ω–µ—Ç
    - |
      API_URL="$CI_SERVER_URL/api/v4"
      PROJECT_ID="$CI_PROJECT_ID"
      SOURCE_BRANCH="$BRANCH"
      TARGET_BRANCH="$CI_DEFAULT_BRANCH"
      TOKEN="$MENTOR_SYNC_TOKEN"

      echo "[sync] Checking existing MR from $SOURCE_BRANCH to $TARGET_BRANCH..."

      EXISTING_MRS=$(curl --silent --header "PRIVATE-TOKEN: $TOKEN" \
        "$API_URL/projects/$PROJECT_ID/merge_requests?source_branch=$SOURCE_BRANCH&target_branch=$TARGET_BRANCH&state=opened")

      if [ "$EXISTING_MRS" = "[]" ]; then
        echo "[sync] No existing MR, creating new one..."

        if curl --silent --show-error --fail \
          --request POST \
          --header "PRIVATE-TOKEN: $TOKEN" \
          "$API_URL/projects/$PROJECT_ID/merge_requests" \
          --data "source_branch=$SOURCE_BRANCH" \
          --data "target_branch=$TARGET_BRANCH" \
          --data-urlencode "title=Mentor sync: $SOURCE_BRANCH ‚Üí $TARGET_BRANCH" \
          --data-urlencode "description=–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π MR —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –∏–∑ —à–∞–±–ª–æ–Ω–∞ –º–µ–Ω—Ç–æ—Ä–∞."; then
          echo "[sync] MR created."
        else
          echo "[sync] ERROR: failed to create MR via API."
          # –ú–æ–∂–Ω–æ –Ω–µ –ø–∞–¥–∞—Ç—å –¥–∂–æ–±–æ–π, –µ—Å–ª–∏ –Ω–µ —Ö–æ—á–µ—à—å –ª–æ–º–∞—Ç—å –ø–∞–π–ø–ª–∞–π–Ω:
          # exit 1
        fi
      else
        echo "[sync] MR already exists or API returned non-empty list:"
        echo "$EXISTING_MRS"
      fi

  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^mentor-sync-/'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: always

codestyle-check:
  stage: codestyle
  image: mcr.microsoft.com/dotnet/sdk:8.0
  allow_failure: true
  variables:
    DOTNET_CLI_TELEMETRY_OPTOUT: "true"
    DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "true"
  script:
    - printf "\033[34m[codestyle-check] Running Roslyn analyzers...\033[0m\n"
    - |
      set -e

      summarize_errors () {
        if [ -f build.log ]; then
          echo ""
          echo "###############################################"
          printf "\033[31m=== –í—ã–≤–æ–¥ –ø–æ –æ—à–∏–±–∫–∞–º –∫–æ–¥—Å—Ç–∞–π–ª–∞ ===\033[0m\n"
          # –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏ SA/IDE ‚Äî —ç—Ç–æ —Ç–≤–æ–π –∫–æ–¥—Å—Ç–∞–π–ª
          grep -E "error (SA|IDE)[0-9]{4}" build.log || echo "No SA/IDE errors found in log."
          echo "###############################################"
        fi
      }

      build_target () {
        target="$1"
        echo "[codestyle-check] Restoring $target"
        dotnet restore "$target"
        echo "[codestyle-check] Building  $target"
        # –õ–æ–≥ –±–∏–ª–¥–∞ –≤ —Ñ–∞–π–ª –∏ –≤ stdout; –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å—Ä–∞–∑—É summary
        if ! dotnet build "$target" |& tee build.log; then
          summarize_errors
          exit 1
        fi
      }

      solution_count=$(find . -name '*.sln' | wc -l)

      if [ "$solution_count" -gt 0 ]; then
        echo "[codestyle-check] Found $solution_count solution file(s). Building all of them..."
        find . -name '*.sln' -print0 | while IFS= read -r -d '' sln; do
          build_target "$sln"
        done
      else
        echo "[codestyle-check] No .sln found, building all .csproj files..."
        find . -name '*.csproj' -print0 | while IFS= read -r -d '' proj; do
          build_target "$proj"
        done
      fi
  rules:
    - if: '$CI_MERGE_REQUEST_IID'